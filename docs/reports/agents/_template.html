<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title id="page-title">Agent Report - Influx</title>
        <link rel="stylesheet" href="../../assets/styles.css" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
            rel="stylesheet"
        />
        <link rel="icon" href="../../assets/images/icon.png" type="image/png" />
        <style>
            .benchmark-query {
                font-weight: 500;
                margin-bottom: var(--space-xs);
            }
            .benchmark-response {
                color: var(--color-text-muted);
                font-size: 0.875rem;
                white-space: pre-wrap;
                max-height: 100px;
                overflow: hidden;
                position: relative;
            }
            .benchmark-response.expanded {
                max-height: none;
            }
            .benchmark-scores {
                display: flex;
                gap: var(--space-md);
                margin-top: var(--space-sm);
            }
            .benchmark-score {
                font-size: 0.75rem;
            }
            .benchmark-score span {
                font-weight: 500;
            }
            .expand-btn {
                background: none;
                border: none;
                color: var(--color-primary);
                cursor: pointer;
                font-size: 0.75rem;
                padding: var(--space-xs) 0;
            }
            .quality-feedback {
                background: var(--color-surface);
                border-radius: var(--radius-md);
                padding: var(--space-md);
                font-size: 0.875rem;
                white-space: pre-wrap;
            }
            .file-score {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: var(--space-sm) 0;
                border-bottom: 1px solid var(--color-border);
            }
            .file-score:last-child {
                border-bottom: none;
            }
            .context-files {
                display: flex;
                flex-wrap: wrap;
                gap: var(--space-xs);
                margin-top: var(--space-sm);
            }
            .context-file {
                background: var(--color-surface);
                padding: var(--space-xs) var(--space-sm);
                border-radius: var(--radius-sm);
                font-size: 0.75rem;
                font-family: monospace;
            }
        </style>
    </head>
    <body>
        <header class="header">
            <div class="container header__inner">
                <div class="flex flex-center gap-md">
                    <a href="../index.html">
                        <img
                            src="../../assets/images/logo.png"
                            alt="Influx"
                            class="header__logo"
                        />
                    </a>
                    <span class="header__title">AI Agent Reports</span>
                </div>
                <nav class="header__nav">
                    <a href="../index.html">Dashboard</a>
                </nav>
            </div>
        </header>

        <main class="main">
            <div class="container">
                <!-- Agent Header -->
                <section class="section">
                    <div class="flex flex-between flex-center">
                        <div>
                            <h1 id="agent-name">Loading...</h1>
                            <p class="text-muted" id="agent-id">-</p>
                        </div>
                        <div class="score" id="quality-score">-</div>
                    </div>

                    <div class="stats mt-lg">
                        <div class="stat">
                            <div class="stat__value" id="total-cases">-</div>
                            <div class="stat__label">Total Tests</div>
                        </div>
                        <div class="stat">
                            <div class="stat__value text-success" id="passed">
                                -
                            </div>
                            <div class="stat__label">Passed</div>
                        </div>
                        <div class="stat">
                            <div class="stat__value text-error" id="failed">
                                -
                            </div>
                            <div class="stat__label">Failed</div>
                        </div>
                        <div class="stat">
                            <div class="stat__value" id="pass-rate">-</div>
                            <div class="stat__label">Pass Rate</div>
                        </div>
                    </div>

                    <div class="context-files" id="context-files"></div>
                </section>

                <!-- Quality Section -->
                <section
                    class="section"
                    id="quality-section"
                    style="display: none"
                >
                    <h2>Quality Evaluation</h2>

                    <div class="card mt-md">
                        <h3>Feedback</h3>
                        <div
                            class="quality-feedback mt-md"
                            id="quality-feedback"
                        >
                            -
                        </div>
                    </div>

                    <div class="card mt-md">
                        <h3>File Scores</h3>
                        <div id="file-scores" class="mt-md">-</div>
                    </div>
                </section>

                <!-- Simulation Results -->
                <section
                    class="section"
                    id="simulation-section"
                    style="display: none"
                >
                    <h2>Benchmark Results</h2>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Hash</th>
                                    <th>Query</th>
                                    <th>Similarity</th>
                                    <th>Faithfulness</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="benchmark-results">
                                <tr>
                                    <td
                                        colspan="5"
                                        class="text-center text-muted"
                                    >
                                        Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Failed Tests Detail -->
                <section
                    class="section"
                    id="failed-section"
                    style="display: none"
                >
                    <h2>Failed Tests</h2>
                    <div id="failed-tests"></div>
                </section>
            </div>
        </main>

        <footer class="footer">
            <div class="container footer__inner">
                <span>Context Engine</span>
                <span id="last-updated">-</span>
            </div>
        </footer>

        <script>
            // Get agent name from URL
            const agentName = window.location.pathname
                .split("/")
                .pop()
                .replace(".html", "");
            const displayName = agentName
                .split("-")
                .map((w) =>
                    w === "ai" ? "AI" : w.charAt(0).toUpperCase() + w.slice(1),
                )
                .join(" ");

            // Score class helper
            function getScoreClass(score) {
                if (score >= 8) return "score--high";
                if (score >= 6) return "score--medium";
                return "score--low";
            }

            // Fetch and render report data
            async function loadReport() {
                try {
                    const response = await fetch(
                        `../../data/${agentName}/report.json`,
                    );
                    if (!response.ok) throw new Error("Report not found");
                    const data = await response.json();
                    renderReport(data);
                } catch (e) {
                    console.error("Failed to load report:", e);
                    document.getElementById("agent-name").textContent =
                        displayName;
                    document.getElementById("agent-id").textContent =
                        "Report not available";
                }
            }

            // Fetch and render simulation data
            async function loadSimulation() {
                try {
                    const response = await fetch(
                        `../../data/${agentName}/simulation.json`,
                    );
                    if (!response.ok) throw new Error("Simulation not found");
                    const data = await response.json();
                    renderSimulation(data);
                } catch (e) {
                    console.warn("No simulation data:", e);
                }
            }

            function renderReport(data) {
                // Update page title
                document.title = `${displayName} - Influx`;
                document.getElementById("page-title").textContent =
                    `${displayName} - Influx`;

                // Header
                document.getElementById("agent-name").textContent = displayName;
                document.getElementById("agent-id").textContent =
                    `Agent ID: ${data.context?.id || "-"}`;

                // Quality score
                const qualityScore =
                    data.quality?.average_score?.toFixed(1) || "-";
                const scoreEl = document.getElementById("quality-score");
                scoreEl.textContent = qualityScore;
                scoreEl.className = `score ${getScoreClass(parseFloat(qualityScore))}`;

                // Simulation stats
                if (data.simulation) {
                    document.getElementById("total-cases").textContent =
                        data.simulation.total_cases || "-";
                    document.getElementById("passed").textContent =
                        data.simulation.passed || "-";
                    document.getElementById("failed").textContent =
                        data.simulation.failed || "-";
                    document.getElementById("pass-rate").textContent =
                        data.simulation.pass_rate !== undefined
                            ? (data.simulation.pass_rate * 100).toFixed(0) + "%"
                            : "-";
                }

                // Context files
                if (data.context?.files) {
                    document.getElementById("context-files").innerHTML =
                        data.context.files
                            .map(
                                (f) => `<span class="context-file">${f}</span>`,
                            )
                            .join("");
                }

                // Quality section
                if (data.quality) {
                    document.getElementById("quality-section").style.display =
                        "block";

                    // Feedback
                    const feedback =
                        data.quality.common_improvements?.join("\n\n") ||
                        data.quality.files?.[0]?.feedback ||
                        "No feedback available";
                    document.getElementById("quality-feedback").textContent =
                        feedback;

                    // File scores
                    if (data.quality.files) {
                        document.getElementById("file-scores").innerHTML =
                            data.quality.files
                                .map(
                                    (f) => `
            <div class="file-score">
              <span class="text-mono text-sm">${f.file}</span>
              <span class="score ${getScoreClass(f.score)}" style="width: 36px; height: 36px; font-size: 1rem;">${f.score}</span>
            </div>
          `,
                                )
                                .join("");
                    }
                }

                // Update timestamp
                if (data.generated_at) {
                    document.getElementById("last-updated").textContent =
                        `Updated ${new Date(data.generated_at).toLocaleDateString()}`;
                }
            }

            function renderSimulation(data) {
                if (!data.results) return;

                document.getElementById("simulation-section").style.display =
                    "block";

                // Render results table
                const tbody = document.getElementById("benchmark-results");
                tbody.innerHTML = data.results
                    .map(
                        (r) => `
        <tr>
          <td class="text-mono text-xs">${r.query_hash || "-"}</td>
          <td>${truncate(r.query, 60)}</td>
          <td>${r.scores?.similarity?.toFixed(3) || "-"}</td>
          <td>${r.scores?.faithfulness?.toFixed(3) || "-"}</td>
          <td><span class="badge ${r.passed ? "badge--pass" : "badge--fail"}">${r.passed ? "Pass" : "Fail"}</span></td>
        </tr>
      `,
                    )
                    .join("");

                // Render failed tests detail
                const failed = data.results.filter((r) => !r.passed);
                if (failed.length > 0) {
                    document.getElementById("failed-section").style.display =
                        "block";
                    document.getElementById("failed-tests").innerHTML = failed
                        .map(
                            (r) => `
          <div class="card mt-md">
            <div class="flex flex-between flex-center">
              <span class="text-mono text-xs">${r.query_hash}</span>
              <span class="badge badge--fail">Failed</span>
            </div>
            <div class="benchmark-query mt-md">${r.query}</div>
            <div class="benchmark-scores">
              <span class="benchmark-score">Similarity: <span>${r.scores?.similarity?.toFixed(3) || "-"}</span></span>
              <span class="benchmark-score">Faithfulness: <span>${r.scores?.faithfulness?.toFixed(3) || "-"}</span></span>
            </div>
            <h4 class="mt-md text-sm">Expected</h4>
            <div class="benchmark-response">${r.expected_response || "-"}</div>
            <h4 class="mt-md text-sm">Generated</h4>
            <div class="benchmark-response">${r.generated_response || "-"}</div>
            ${
                r.failure_reasons?.length
                    ? `
              <h4 class="mt-md text-sm text-error">Failure Reasons</h4>
              <ul class="text-sm text-muted">
                ${r.failure_reasons.map((reason) => `<li>${reason}</li>`).join("")}
              </ul>
            `
                    : ""
            }
          </div>
        `,
                        )
                        .join("");
                }
            }

            function truncate(str, len) {
                if (!str) return "-";
                return str.length > len ? str.substring(0, len) + "..." : str;
            }

            // Initialize
            loadReport();
            loadSimulation();
        </script>
    </body>
</html>
